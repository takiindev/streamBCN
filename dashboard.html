<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Stream Socket</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --primary-color: #2563eb;
            --secondary-color: #64748b;
            --success-color: #16a34a;
            --danger-color: #dc2626;
            --warning-color: #ca8a04;
            --dark-color: #1e293b;
        }

        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .sidebar {
            background: linear-gradient(180deg, var(--dark-color) 0%, #334155 100%);
            min-height: 100vh;
            box-shadow: 4px 0 10px rgba(0,0,0,0.1);
        }

        .sidebar .nav-link {
            color: #e2e8f0;
            padding: 12px 20px;
            margin: 4px 8px;
            border-radius: 8px;
            transition: all 0.3s ease;
        }

        .sidebar .nav-link:hover,
        .sidebar .nav-link.active {
            background: rgba(59, 130, 246, 0.2);
            color: #60a5fa;
            transform: translateX(4px);
        }

        .main-content {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            margin: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }

        .stats-card {
            background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
            border: none;
            border-radius: 16px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.08);
            transition: all 0.3s ease;
        }

        .stats-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 35px rgba(0,0,0,0.12);
        }

        .stats-icon {
            width: 60px;
            height: 60px;
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            margin-bottom: 15px;
        }

        .icon-primary { background: linear-gradient(135deg, #3b82f6, #1d4ed8); color: white; }
        .icon-success { background: linear-gradient(135deg, #10b981, #059669); color: white; }
        .icon-danger { background: linear-gradient(135deg, #ef4444, #dc2626); color: white; }
        .icon-warning { background: linear-gradient(135deg, #f59e0b, #d97706); color: white; }
        .icon-info { background: linear-gradient(135deg, #06b6d4, #0891b2); color: white; }

        .table-container {
            background: white;
            border-radius: 16px;
            padding: 25px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.08);
            margin-top: 20px;
        }

        .table th {
            background: linear-gradient(135deg, #f8fafc, #e2e8f0);
            border: none;
            font-weight: 600;
            color: var(--dark-color);
            padding: 15px;
        }

        .badge-status {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
        }

        .btn-action {
            padding: 6px 12px;
            margin: 2px;
            border-radius: 8px;
            font-size: 12px;
            border: none;
            transition: all 0.3s ease;
        }

        .btn-action:hover {
            transform: scale(1.05);
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: var(--secondary-color);
        }

        .modal-content {
            border-radius: 16px;
            border: none;
            box-shadow: 0 20px 60px rgba(0,0,0,0.15);
        }

        .modal-header {
            background: linear-gradient(135deg, var(--primary-color), #1d4ed8);
            color: white;
            border-radius: 16px 16px 0 0;
            border: none;
        }

        .search-box {
            background: white;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            padding: 12px 20px;
            transition: all 0.3s ease;
        }

        .search-box:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
            outline: none;
        }

        .refresh-btn {
            background: linear-gradient(135deg, var(--primary-color), #1d4ed8);
            border: none;
            border-radius: 12px;
            padding: 12px 24px;
            color: white;
            transition: all 0.3s ease;
        }

        .refresh-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(59, 130, 246, 0.3);
            color: white;
        }

        .alert-custom {
            border: none;
            border-radius: 12px;
            padding: 16px 24px;
        }

        @media (max-width: 768px) {
            .main-content {
                margin: 10px;
                padding: 20px;
            }
            
            .sidebar {
                position: fixed;
                top: 0;
                left: -250px;
                width: 250px;
                z-index: 1000;
                transition: left 0.3s ease;
            }
            
            .sidebar.show {
                left: 0;
            }
        }
    </style>
</head>
<body>
    <!-- Admin Login Modal -->
    <div class="modal fade" id="loginModal" tabindex="-1" data-bs-backdrop="static">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-user-shield me-2"></i> Admin Login
                    </h5>
                </div>
                <div class="modal-body">
                    <form id="loginForm">
                        <div class="mb-3">
                            <label class="form-label">Admin ID (Student ID):</label>
                            <input type="text" class="form-control" id="loginStudentId" 
                                   placeholder="Nhập admin student ID" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Password (Birth Date):</label>
                            <input type="text" class="form-control" id="loginBirthDate" 
                                   placeholder="dd/mm/yyyy" required>
                            <small class="form-text text-muted">Định dạng: dd/mm/yyyy</small>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" onclick="performLogin()">
                        <i class="fas fa-sign-in-alt me-2"></i> Login
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="container-fluid" id="main-app" style="display: none;">
        <div class="row">
            <!-- Sidebar -->
            <div class="col-md-2 col-lg-2 p-0">
                <div class="sidebar">
                    <div class="p-4">
                        <h4 class="text-white mb-4">
                            <i class="fas fa-cogs me-2"></i>
                            Admin Panel
                        </h4>
                        <nav class="nav flex-column">
                            <a class="nav-link active" href="#dashboard" data-section="dashboard">
                                <i class="fas fa-tachometer-alt me-2"></i> Dashboard
                            </a>
                            <a class="nav-link" href="#users" data-section="users">
                                <i class="fas fa-users me-2"></i> Quản lý Users
                            </a>
                            <a class="nav-link" href="#online" data-section="online">
                                <i class="fas fa-circle text-success me-2"></i> Users Online
                            </a>
                            <a class="nav-link" href="#banned" data-section="banned">
                                <i class="fas fa-ban me-2"></i> Users Bị Cấm
                            </a>
                            <a class="nav-link" href="#messages" data-section="messages">
                                <i class="fas fa-comments me-2"></i> Quản lý Tin nhắn
                            </a>
                            <a class="nav-link" href="#system" data-section="system">
                                <i class="fas fa-server me-2"></i> Hệ thống
                            </a>
                        </nav>
                    </div>
                </div>
            </div>

            <!-- Main Content -->
            <div class="col-md-10 col-lg-10">
                <div class="main-content">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <div>
                            <h2 id="page-title">Dashboard</h2>
                            <small class="text-muted">Welcome, <span id="admin-name">Admin</span></small>
                            <br>
                            <small id="realtime-status" class="text-success">
                                <i class="fas fa-circle text-success"></i> Realtime Connected
                            </small>
                        </div>
                        <div>
                            <button class="btn refresh-btn me-2" onclick="refreshData()">
                                <i class="fas fa-sync-alt me-2"></i> Refresh
                            </button>
                            <button class="btn btn-outline-danger" onclick="logout()">
                                <i class="fas fa-sign-out-alt me-2"></i> Logout
                            </button>
                        </div>
                    </div>

                    <!-- Alert Container -->
                    <div id="alert-container"></div>

                    <!-- Dashboard Section -->
                    <div id="dashboard-section" class="content-section">
                        <div class="row" id="stats-container">
                            <div class="col-md-6 col-lg-3">
                                <div class="stats-card">
                                    <div class="stats-icon icon-primary">
                                        <i class="fas fa-users"></i>
                                    </div>
                                    <h3 class="mb-1" id="total-users">-</h3>
                                    <p class="text-muted mb-0">Tổng Users</p>
                                </div>
                            </div>
                            <div class="col-md-6 col-lg-3">
                                <div class="stats-card">
                                    <div class="stats-icon icon-success">
                                        <i class="fas fa-circle"></i>
                                    </div>
                                    <h3 class="mb-1" id="online-users">-</h3>
                                    <p class="text-muted mb-0">Users Online</p>
                                </div>
                            </div>
                            <div class="col-md-6 col-lg-3">
                                <div class="stats-card">
                                    <div class="stats-icon icon-danger">
                                        <i class="fas fa-ban"></i>
                                    </div>
                                    <h3 class="mb-1" id="banned-users">-</h3>
                                    <p class="text-muted mb-0">Users Bị Cấm</p>
                                </div>
                            </div>
                            <div class="col-md-6 col-lg-3">
                                <div class="stats-card">
                                    <div class="stats-icon icon-info">
                                        <i class="fas fa-comments"></i>
                                    </div>
                                    <h3 class="mb-1" id="total-messages">-</h3>
                                    <p class="text-muted mb-0">Tổng Tin nhắn</p>
                                </div>
                            </div>
                        </div>

                        <div class="row mt-4">
                            <div class="col-md-6">
                                <div class="stats-card">
                                    <div class="stats-icon icon-warning">
                                        <i class="fas fa-home"></i>
                                    </div>
                                    <h3 class="mb-1" id="active-rooms">-</h3>
                                    <p class="text-muted mb-0">Phòng Đang Hoạt động</p>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="stats-card">
                                    <div class="stats-icon icon-primary">
                                        <i class="fas fa-buffer"></i>
                                    </div>
                                    <h3 class="mb-1" id="buffered-messages">-</h3>
                                    <p class="text-muted mb-0">Tin nhắn Trong Buffer</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Users Section -->
                    <div id="users-section" class="content-section" style="display: none;">
                        <div class="d-flex justify-content-between align-items-center mb-4">
                            <div class="flex-grow-1 me-3">
                                <input type="text" class="form-control search-box" id="user-search" 
                                       placeholder="Tìm kiếm user theo ID, tên...">
                            </div>
                            <button class="btn btn-primary" onclick="searchUser()">
                                <i class="fas fa-search me-2"></i> Tìm kiếm
                            </button>
                        </div>

                        <div class="table-container">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h5 class="mb-0">Danh sách Users</h5>
                                <div id="users-pagination" class="d-flex align-items-center">
                                    <span class="me-3 text-muted" id="users-info">-</span>
                                    <div class="btn-group" role="group">
                                        <button class="btn btn-outline-primary btn-sm" onclick="loadUsers(currentPage - 1)" 
                                                id="prev-btn" disabled>
                                            <i class="fas fa-chevron-left"></i>
                                        </button>
                                        <button class="btn btn-outline-primary btn-sm" onclick="loadUsers(currentPage + 1)" 
                                                id="next-btn" disabled>
                                            <i class="fas fa-chevron-right"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead>
                                        <tr>
                                            <th>Student ID</th>
                                            <th>Họ Tên</th>
                                            <th>Trạng thái</th>
                                            <th>Online Status</th>
                                            <th>Phòng Hiện tại</th>
                                            <th>Lần Cuối Đăng nhập</th>
                                            <th>Hành động</th>
                                        </tr>
                                    </thead>
                                    <tbody id="users-table-body">
                                        <tr>
                                            <td colspan="7" class="loading">
                                                <i class="fas fa-spinner fa-spin me-2"></i> Đang tải...
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Online Users Section -->
                    <div id="online-section" class="content-section" style="display: none;">
                        <div class="table-container">
                            <h5 class="mb-3">Users Đang Online</h5>
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead>
                                        <tr>
                                            <th>Student ID</th>
                                            <th>Họ Tên</th>
                                            <th>Phòng Hiện tại</th>
                                            <th>Hoạt động Cuối</th>
                                            <th>Hành động</th>
                                        </tr>
                                    </thead>
                                    <tbody id="online-users-table-body">
                                        <tr>
                                            <td colspan="5" class="loading">
                                                <i class="fas fa-spinner fa-spin me-2"></i> Đang tải...
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Banned Users Section -->
                    <div id="banned-section" class="content-section" style="display: none;">
                        <div class="table-container">
                            <h5 class="mb-3">Users Bị Cấm</h5>
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead>
                                        <tr>
                                            <th>Student ID</th>
                                            <th>Họ Tên</th>
                                            <th>Lý do</th>
                                            <th>Cấm bởi</th>
                                            <th>Ngày cấm</th>
                                            <th>Hành động</th>
                                        </tr>
                                    </thead>
                                    <tbody id="banned-users-table-body">
                                        <tr>
                                            <td colspan="6" class="loading">
                                                <i class="fas fa-spinner fa-spin me-2"></i> Đang tải...
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Messages Section -->
                    <div id="messages-section" class="content-section" style="display: none;">
                        <div class="alert alert-info alert-custom">
                            <i class="fas fa-info-circle me-2"></i>
                            Chức năng xóa tin nhắn sẽ được phát triển thêm. Hiện tại bạn có thể xóa tin nhắn thông qua API endpoints.
                        </div>
                    </div>

                    <!-- System Section -->
                    <div id="system-section" class="content-section" style="display: none;">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="table-container">
                                    <h5 class="mb-3">Thống kê Buffer</h5>
                                    <div id="buffer-stats">
                                        <div class="loading">
                                            <i class="fas fa-spinner fa-spin me-2"></i> Đang tải...
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="table-container">
                                    <h5 class="mb-3">Hành động Hệ thống</h5>
                                    <button class="btn btn-warning mb-3" onclick="flushMessages()">
                                        <i class="fas fa-database me-2"></i> Flush Messages to DB
                                    </button>
                                    <p class="text-muted">Đẩy tất cả tin nhắn trong buffer về database</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Ban User Modal -->
    <div class="modal fade" id="banUserModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-ban me-2"></i> Cấm User
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="banUserForm">
                        <div class="mb-3">
                            <label class="form-label">User ID:</label>
                            <input type="text" class="form-control" id="banUserId" readonly>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Lý do cấm:</label>
                            <textarea class="form-control" id="banReason" rows="3" 
                                    placeholder="Nhập lý do cấm user..."></textarea>
                        </div>
                                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>
                            Hành động này sẽ được ghi nhận dưới tên admin đang đăng nhập
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                    <button type="button" class="btn btn-danger" onclick="confirmBanUser()">
                        <i class="fas fa-ban me-2"></i> Cấm User
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.js"></script>
    <script>
        // Global variables
        let currentPage = 1;
        const pageSize = 50;
        let currentSection = 'dashboard';
        let authToken = null;
        let adminInfo = null;
        let socket = null;

        // API Base URL
        const API_BASE = '/admin';
        const AUTH_BASE = '/auth';

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            checkAuthentication();
        });

        // Authentication functions
        function checkAuthentication() {
            const token = localStorage.getItem('admin_token');
            const admin = localStorage.getItem('admin_info');
            
            if (token && admin) {
                authToken = token;
                adminInfo = JSON.parse(admin);
                showMainApp();
            } else {
                showLoginModal();
            }
        }

        function showLoginModal() {
            const modal = new bootstrap.Modal(document.getElementById('loginModal'));
            modal.show();
        }

        function showMainApp() {
            document.getElementById('main-app').style.display = 'block';
            document.getElementById('admin-name').textContent = adminInfo?.fullName || 'Admin';
            initializeSidebar();
            connectWebSocket();
            loadDashboardStats();
        }

        async function performLogin() {
            const studentId = document.getElementById('loginStudentId').value.trim();
            const birthDate = document.getElementById('loginBirthDate').value.trim();

            if (!studentId || !birthDate) {
                showAlert('Vui lòng nhập đầy đủ thông tin', 'warning');
                return;
            }

            try {
                const response = await fetch(`${AUTH_BASE}/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ studentId, birthDate })
                });

                const result = await response.json();

                if (response.ok) {
                    // Check if user has admin role
                    const userCheckResponse = await fetch(`${API_BASE}/dashboard/stats`, {
                        headers: { 'Authorization': `Bearer ${result.access_token}` }
                    });

                    if (userCheckResponse.ok) {
                        // Store auth data
                        authToken = result.access_token;
                        adminInfo = result.user;
                        localStorage.setItem('admin_token', authToken);
                        localStorage.setItem('admin_info', JSON.stringify(adminInfo));

                        // Hide login modal and show main app
                        const modal = bootstrap.Modal.getInstance(document.getElementById('loginModal'));
                        modal.hide();
                        
                        showMainApp();
                        showAlert(`Đăng nhập thành công! Chào mừng ${adminInfo.fullName}`, 'success');
                    } else {
                        showAlert('Bạn không có quyền admin để truy cập dashboard này', 'danger');
                    }
                } else {
                    showAlert(result.message || 'Đăng nhập thất bại', 'danger');
                }
            } catch (error) {
                console.error('Login error:', error);
                showAlert('Lỗi kết nối server', 'danger');
            }
        }

        function logout() {
            if (confirm('Bạn có chắc muốn đăng xuất?')) {
                disconnectWebSocket();
                localStorage.removeItem('admin_token');
                localStorage.removeItem('admin_info');
                location.reload();
            }
        }

        // Helper function for authenticated API calls
        async function authenticatedFetch(url, options = {}) {
            const defaultOptions = {
                headers: {
                    'Authorization': `Bearer ${authToken}`,
                    'Content-Type': 'application/json',
                    ...options.headers
                }
            };

            const response = await fetch(url, { ...options, headers: defaultOptions.headers });
            
            if (response.status === 403) {
                showAlert('Phiên đăng nhập hết hạn', 'warning');
                logout();
                return null;
            }

            return response;
        }

        // Sidebar navigation
        function initializeSidebar() {
            const navLinks = document.querySelectorAll('.sidebar .nav-link');
            
            navLinks.forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    
                    // Update active link
                    navLinks.forEach(l => l.classList.remove('active'));
                    this.classList.add('active');
                    
                    // Show section
                    const section = this.getAttribute('data-section');
                    showSection(section);
                });
            });
        }

        function showSection(section) {
            // Hide all sections
            document.querySelectorAll('.content-section').forEach(s => {
                s.style.display = 'none';
            });
            
            // Show selected section
            document.getElementById(section + '-section').style.display = 'block';
            
            // Update page title
            const titles = {
                'dashboard': 'Dashboard',
                'users': 'Quản lý Users',
                'online': 'Users Online',
                'banned': 'Users Bị Cấm',
                'messages': 'Quản lý Tin nhắn',
                'system': 'Hệ thống'
            };
            
            document.getElementById('page-title').textContent = titles[section];
            currentSection = section;
            
            // Load section data
            loadSectionData(section);
        }

        function loadSectionData(section) {
            switch(section) {
                case 'dashboard':
                    loadDashboardStats();
                    break;
                case 'users':
                    loadUsers(1);
                    break;
                case 'online':
                    loadOnlineUsers();
                    break;
                case 'banned':
                    loadBannedUsers();
                    break;
                case 'system':
                    loadBufferStats();
                    break;
            }
        }

        // Dashboard functions
        async function loadDashboardStats() {
            try {
                const response = await authenticatedFetch(`${API_BASE}/dashboard/stats`);
                if (!response) return;
                
                const stats = await response.json();
                
                document.getElementById('total-users').textContent = stats.totalUsers || 0;
                document.getElementById('online-users').textContent = stats.onlineUsers || 0;
                document.getElementById('banned-users').textContent = stats.bannedUsers || 0;
                document.getElementById('total-messages').textContent = stats.totalMessages || 0;
                document.getElementById('active-rooms').textContent = stats.activeRooms || 0;
                document.getElementById('buffered-messages').textContent = stats.bufferedMessages || 0;
            } catch (error) {
                console.error('Error loading dashboard stats:', error);
                showAlert('Không thể tải thống kê dashboard', 'danger');
            }
        }

        // Users functions
        async function loadUsers(page = 1) {
            try {
                showTableLoading('users-table-body', 7);
                
                const response = await authenticatedFetch(`${API_BASE}/users?page=${page}&limit=${pageSize}`);
                if (!response) return;
                const data = await response.json();
                
                currentPage = page;
                renderUsersTable(data.users);
                updatePagination(data.total, data.totalPages);
                
            } catch (error) {
                console.error('Error loading users:', error);
                showAlert('Không thể tải danh sách users', 'danger');
            }
        }

        function renderUsersTable(users) {
            const tbody = document.getElementById('users-table-body');
            
            if (users.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="text-center py-4">Không có dữ liệu</td></tr>';
                return;
            }

            tbody.innerHTML = users.map(user => `
                <tr>
                    <td><strong>${user.studentId}</strong></td>
                    <td>${user.fullName}</td>
                    <td>
                        <span class="badge badge-status ${user.isBanned ? 'bg-danger' : (user.isActive ? 'bg-success' : 'bg-secondary')}">
                            ${user.isBanned ? 'Bị cấm' : (user.isActive ? 'Hoạt động' : 'Không hoạt động')}
                        </span>
                    </td>
                    <td>
                        <span class="badge badge-status ${user.isOnline ? 'bg-success' : 'bg-secondary'}">
                            <i class="fas fa-circle me-1" style="font-size: 8px;"></i>
                            ${user.isOnline ? 'Online' : 'Offline'}
                        </span>
                    </td>
                    <td>${user.currentRoom || '-'}</td>
                    <td>${formatDateTime(user.lastLogin)}</td>
                    <td>
                        ${user.isBanned ? 
                            `<button class="btn btn-success btn-action" onclick="unbanUser('${user.studentId}')">
                                <i class="fas fa-unlock me-1"></i> Mở khóa
                            </button>` :
                            `<button class="btn btn-danger btn-action" onclick="showBanModal('${user.studentId}')">
                                <i class="fas fa-ban me-1"></i> Cấm
                            </button>`
                        }
                        <button class="btn btn-primary btn-action" onclick="viewUserDetails('${user.studentId}')">
                            <i class="fas fa-eye me-1"></i> Chi tiết
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        async function loadOnlineUsers() {
            try {
                showTableLoading('online-users-table-body', 5);
                
                const response = await authenticatedFetch(`${API_BASE}/users/online`);
                if (!response) return;
                const users = await response.json();
                
                const tbody = document.getElementById('online-users-table-body');
                
                if (users.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" class="text-center py-4">Không có user online</td></tr>';
                    return;
                }

                tbody.innerHTML = users.map(user => `
                    <tr>
                        <td><strong>${user.studentId}</strong></td>
                        <td>${user.fullName}</td>
                        <td>${user.currentRoom || '-'}</td>
                        <td>${formatDateTime(user.lastActivity)}</td>
                        <td>
                            ${!user.isBanned ? 
                                `<button class="btn btn-danger btn-action" onclick="showBanModal('${user.studentId}')">
                                    <i class="fas fa-ban me-1"></i> Cấm
                                </button>` : ''
                            }
                        </td>
                    </tr>
                `).join('');
                
            } catch (error) {
                console.error('Error loading online users:', error);
                showAlert('Không thể tải danh sách users online', 'danger');
            }
        }

        async function loadBannedUsers() {
            try {
                showTableLoading('banned-users-table-body', 6);
                
                const response = await authenticatedFetch(`${API_BASE}/users/banned`);
                if (!response) return;
                const users = await response.json();
                
                const tbody = document.getElementById('banned-users-table-body');
                
                if (users.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" class="text-center py-4">Không có user bị cấm</td></tr>';
                    return;
                }

                tbody.innerHTML = users.map(user => `
                    <tr>
                        <td><strong>${user.studentId}</strong></td>
                        <td>${user.fullName}</td>
                        <td>${user.bannedReason || '-'}</td>
                        <td>${user.bannedBy || '-'}</td>
                        <td>${formatDateTime(user.bannedAt)}</td>
                        <td>
                            <button class="btn btn-success btn-action" onclick="unbanUser('${user.studentId}')">
                                <i class="fas fa-unlock me-1"></i> Mở khóa
                            </button>
                        </td>
                    </tr>
                `).join('');
                
            } catch (error) {
                console.error('Error loading banned users:', error);
                showAlert('Không thể tải danh sách users bị cấm', 'danger');
            }
        }

        // System functions
        async function loadBufferStats() {
            try {
                const response = await authenticatedFetch(`${API_BASE}/buffer-stats`);
                if (!response) return;
                const stats = await response.json();
                
                const container = document.getElementById('buffer-stats');
                container.innerHTML = `
                    <div class="row">
                        <div class="col-6 mb-3">
                            <strong>Pending Writes:</strong>
                            <span class="badge bg-warning ms-2">${stats.pendingWrites || 0}</span>
                        </div>
                        <div class="col-6 mb-3">
                            <strong>Total Recent Messages:</strong>
                            <span class="badge bg-info ms-2">${stats.totalRecentMessages || 0}</span>
                        </div>
                        <div class="col-6 mb-3">
                            <strong>Active Rooms:</strong>
                            <span class="badge bg-success ms-2">${stats.activeRooms || 0}</span>
                        </div>
                        <div class="col-6 mb-3">
                            <strong>Batch Size:</strong>
                            <span class="badge bg-secondary ms-2">${stats.batchSize || 0}</span>
                        </div>
                    </div>
                `;
                
            } catch (error) {
                console.error('Error loading buffer stats:', error);
                document.getElementById('buffer-stats').innerHTML = 
                    '<div class="alert alert-danger">Không thể tải thống kê buffer</div>';
            }
        }

        async function flushMessages() {
            if (!confirm('Bạn có chắc muốn flush tất cả messages về database?')) return;
            
            try {
                const response = await authenticatedFetch(`${API_BASE}/flush-messages`, { method: 'POST' });
                if (!response) return;
                const result = await response.json();
                
                showAlert('Đã flush messages thành công', 'success');
                loadBufferStats(); // Refresh stats
                
            } catch (error) {
                console.error('Error flushing messages:', error);
                showAlert('Không thể flush messages', 'danger');
            }
        }

        // User management functions
        function showBanModal(userId) {
            document.getElementById('banUserId').value = userId;
            document.getElementById('banReason').value = '';
            
            const modal = new bootstrap.Modal(document.getElementById('banUserModal'));
            modal.show();
        }

        async function confirmBanUser() {
            const userId = document.getElementById('banUserId').value;
            const reason = document.getElementById('banReason').value;

            try {
                const response = await authenticatedFetch(`${API_BASE}/users/ban`, {
                    method: 'POST',
                    body: JSON.stringify({
                        userId: userId,
                        reason: reason || 'Vi phạm quy định'
                    })
                });

                const result = await response.json();
                
                if (response.ok) {
                    showAlert(`User ${userId} đã bị cấm thành công`, 'success');
                    
                    // Hide modal
                    const modal = bootstrap.Modal.getInstance(document.getElementById('banUserModal'));
                    modal.hide();
                    
                    // Refresh current section
                    loadSectionData(currentSection);
                    loadDashboardStats();
                } else {
                    showAlert(result.message || 'Không thể cấm user', 'danger');
                }
                
            } catch (error) {
                console.error('Error banning user:', error);
                showAlert('Lỗi khi cấm user', 'danger');
            }
        }

        async function unbanUser(userId) {
            if (!confirm(`Bạn có chắc muốn mở khóa user ${userId}?`)) return;
            
            try {
                const response = await authenticatedFetch(`${API_BASE}/users/unban`, {
                    method: 'POST',
                    body: JSON.stringify({ userId: userId })
                });

                if (!response) return;
                const result = await response.json();
                
                if (response.ok) {
                    showAlert(`User ${userId} đã được mở khóa`, 'success');
                    loadSectionData(currentSection);
                    loadDashboardStats();
                } else {
                    showAlert(result.message || 'Không thể mở khóa user', 'danger');
                }
                
            } catch (error) {
                console.error('Error unbanning user:', error);
                showAlert('Lỗi khi mở khóa user', 'danger');
            }
        }

        async function viewUserDetails(userId) {
            try {
                const response = await authenticatedFetch(`${API_BASE}/users/status?userId=${userId}`);
                if (!response) return;
                const users = await response.json();
                
                if (users.length > 0) {
                    const user = users[0];
                    let details = `
                        <strong>Student ID:</strong> ${user.studentId}<br>
                        <strong>Họ tên:</strong> ${user.fullName}<br>
                        <strong>Trạng thái:</strong> ${user.isBanned ? 'Bị cấm' : (user.isActive ? 'Hoạt động' : 'Không hoạt động')}<br>
                        <strong>Online:</strong> ${user.isOnline ? 'Có' : 'Không'}<br>
                        <strong>Phòng hiện tại:</strong> ${user.currentRoom || 'Không có'}<br>
                        <strong>Lần cuối đăng nhập:</strong> ${formatDateTime(user.lastLogin)}<br>
                    `;
                    
                    if (user.isBanned) {
                        details += `
                            <strong>Lý do cấm:</strong> ${user.bannedReason || '-'}<br>
                            <strong>Cấm bởi:</strong> ${user.bannedBy || '-'}<br>
                            <strong>Ngày cấm:</strong> ${formatDateTime(user.bannedAt)}<br>
                        `;
                    }
                    
                    showAlert(details, 'info');
                } else {
                    showAlert('Không tìm thấy user', 'warning');
                }
                
            } catch (error) {
                console.error('Error viewing user details:', error);
                showAlert('Không thể tải thông tin user', 'danger');
            }
        }

        async function searchUser() {
            const searchTerm = document.getElementById('user-search').value.trim();
            
            if (!searchTerm) {
                loadUsers(1);
                return;
            }

            try {
                const response = await authenticatedFetch(`${API_BASE}/users/status?userId=${searchTerm}&studentId=${searchTerm}`);
                if (!response) return;
                const users = await response.json();
                
                renderUsersTable(users);
                document.getElementById('users-info').textContent = `Tìm thấy ${users.length} kết quả`;
                
                // Hide pagination for search results
                document.getElementById('prev-btn').style.display = 'none';
                document.getElementById('next-btn').style.display = 'none';
                
            } catch (error) {
                console.error('Error searching user:', error);
                showAlert('Lỗi khi tìm kiếm user', 'danger');
            }
        }

        // Utility functions
        function updatePagination(total, totalPages) {
            document.getElementById('users-info').textContent = 
                `Trang ${currentPage} / ${totalPages} (${total} users)`;
            
            document.getElementById('prev-btn').disabled = currentPage <= 1;
            document.getElementById('next-btn').disabled = currentPage >= totalPages;
            document.getElementById('prev-btn').style.display = 'inline-block';
            document.getElementById('next-btn').style.display = 'inline-block';
        }

        function showTableLoading(tableBodyId, colspan) {
            document.getElementById(tableBodyId).innerHTML = 
                `<tr><td colspan="${colspan}" class="loading"><i class="fas fa-spinner fa-spin me-2"></i> Đang tải...</td></tr>`;
        }

        function showAlert(message, type) {
            const alertContainer = document.getElementById('alert-container');
            const alertId = 'alert-' + Date.now();
            
            const alertHTML = `
                <div id="${alertId}" class="alert alert-${type} alert-custom alert-dismissible fade show" role="alert">
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;
            
            alertContainer.insertAdjacentHTML('beforeend', alertHTML);
            
            // Auto remove after 5 seconds
            setTimeout(() => {
                const alert = document.getElementById(alertId);
                if (alert) {
                    const bsAlert = new bootstrap.Alert(alert);
                    bsAlert.close();
                }
            }, 5000);
        }

        function formatDateTime(dateString) {
            if (!dateString) return '-';
            
            const date = new Date(dateString);
            return date.toLocaleString('vi-VN', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        function refreshData() {
            loadSectionData(currentSection);
            if (currentSection === 'dashboard') {
                loadDashboardStats();
            }
            showAlert('Đã làm mới dữ liệu', 'info');
        }

        // WebSocket Connection for Realtime Updates
        function connectWebSocket() {
            if (!authToken) return;

            // Disconnect existing connection
            if (socket) {
                socket.disconnect();
            }

            // Connect to WebSocket with auth token
            socket = io({
                query: { token: authToken },
                transports: ['websocket'],
                forceNew: true
            });

            socket.on('connect', () => {
                console.log('Admin dashboard connected to WebSocket');
                document.getElementById('realtime-status').innerHTML = 
                    '<i class="fas fa-circle text-success"></i> Realtime Connected';
                showAlert('Kết nối realtime thành công', 'success');
            });

            socket.on('disconnect', () => {
                console.log('Admin dashboard disconnected from WebSocket');
                document.getElementById('realtime-status').innerHTML = 
                    '<i class="fas fa-circle text-danger"></i> Realtime Disconnected';
                showAlert('Mất kết nối realtime', 'warning');
            });

            socket.on('connect_error', (error) => {
                console.error('WebSocket connection error:', error);
                showAlert('Lỗi kết nối realtime', 'danger');
            });

            // Listen for admin events
            socket.on('admin:userBanned', (data) => {
                console.log('User banned event:', data);
                showAlert(`User ${data.userId} đã bị cấm bởi ${data.bannedBy}. Lý do: ${data.reason}`, 'warning');
                
                // Refresh current section if viewing users
                if (['users', 'online', 'banned'].includes(currentSection)) {
                    setTimeout(() => loadSectionData(currentSection), 1000);
                }
                
                // Update dashboard stats
                loadDashboardStats();
            });

            socket.on('admin:userUnbanned', (data) => {
                console.log('User unbanned event:', data);
                showAlert(`User ${data.userId} đã được mở khóa`, 'info');
                
                // Refresh current section if viewing users
                if (['users', 'online', 'banned'].includes(currentSection)) {
                    setTimeout(() => loadSectionData(currentSection), 1000);
                }
                
                // Update dashboard stats
                loadDashboardStats();
            });

            // Listen for user connection/disconnection events
            socket.on('userConnected', (data) => {
                if (currentSection === 'online') {
                    loadOnlineUsers();
                }
                loadDashboardStats();
            });

            socket.on('userDisconnected', (data) => {
                if (currentSection === 'online') {
                    loadOnlineUsers();
                }
                loadDashboardStats();
            });

            // Listen for new messages for realtime stats
            socket.on('newMessage', (data) => {
                if (currentSection === 'dashboard') {
                    loadDashboardStats();
                }
            });
        }

        function disconnectWebSocket() {
            if (socket) {
                socket.disconnect();
                socket = null;
            }
        }

        // Auto refresh every 30 seconds for dashboard
        setInterval(() => {
            if (currentSection === 'dashboard') {
                loadDashboardStats();
            }
        }, 30000);
    </script>
</body>
</html>
