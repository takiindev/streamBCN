<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LiveStream Chat - High Performance</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #1a1a1a 0%, #2d1b69 100%);
            color: #fff;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            display: grid;
            grid-template-columns: 1fr 350px;
            gap: 20px;
            height: 100vh;
        }
        
        .main-content {
            display: flex;
            flex-direction: column;
        }
        
        .sidebar {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 15px;
            padding: 20px;
            backdrop-filter: blur(10px);
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
            background: rgba(0, 0, 0, 0.2);
            padding: 20px;
            border-radius: 15px;
            backdrop-filter: blur(10px);
        }
        
        .header h1 {
            background: linear-gradient(45deg, #ff6b6b, #4ecdc4);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            font-size: 2em;
            margin-bottom: 10px;
        }
        
        .connection-status {
            padding: 12px 20px;
            border-radius: 25px;
            margin-bottom: 20px;
            text-align: center;
            font-weight: bold;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .connected {
            background: linear-gradient(45deg, #4CAF50, #45a049);
            box-shadow: 0 4px 15px rgba(76, 175, 80, 0.3);
        }
        
        .disconnected {
            background: linear-gradient(45deg, #f44336, #d32f2f);
            box-shadow: 0 4px 15px rgba(244, 67, 54, 0.3);
        }
        
        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #fff;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #e0e0e0;
        }
        
        input, button, select {
            width: 100%;
            padding: 15px;
            border: 2px solid rgba(255, 255, 255, 0.1);
            background: rgba(0, 0, 0, 0.3);
            color: #fff;
            border-radius: 10px;
            font-size: 16px;
            transition: all 0.3s ease;
        }
        
        input:focus, select:focus {
            outline: none;
            border-color: #4ecdc4;
            box-shadow: 0 0 15px rgba(78, 205, 196, 0.3);
        }
        
        button {
            background: linear-gradient(45deg, #4ecdc4, #44a08d);
            cursor: pointer;
            margin-top: 10px;
            font-weight: 600;
            border: none;
            transition: all 0.3s ease;
        }
        
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(78, 205, 196, 0.3);
        }
        
        button:disabled {
            background: #666;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .auth-section {
            background: rgba(0, 0, 0, 0.3);
            padding: 30px;
            border-radius: 15px;
            backdrop-filter: blur(10px);
            margin-bottom: 20px;
        }
        
        .chat-container {
            display: none;
            flex-direction: column;
            height: calc(100vh - 200px);
        }
        
        .chat-messages {
            flex: 1;
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 20px;
            overflow-y: auto;
            background: rgba(0, 0, 0, 0.2);
            backdrop-filter: blur(10px);
            margin-bottom: 20px;
        }
        
        .message {
            margin-bottom: 15px;
            padding: 12px 16px;
            border-radius: 5px;
            background: #333;
        }
        
        .message-header {
            font-size: 12px;
            color: #888;
            margin-bottom: 3px;
        }
        
        .message-content {
            word-wrap: break-word;
        }
        
        .system-message {
            background: #444;
            font-style: italic;
            color: #ccc;
        }
        
        .message-input {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        
        .message {
            margin-bottom: 15px;
            padding: 12px 16px;
            background: rgba(0, 0, 0, 0.5);
            border-radius: 10px;
            animation: slideIn 0.3s ease;
        }
        
        @keyframes slideIn {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        .message.own {
            background: linear-gradient(45deg, #4ecdc4, #44a08d);
            margin-left: 20%;
            text-align: right;
        }
        
        .message.other {
            background: rgba(255, 255, 255, 0.1);
            margin-right: 20%;
        }
        
        .message-header {
            font-weight: 600;
            margin-bottom: 5px;
            font-size: 14px;
        }
        
        .message-content {
            font-size: 16px;
            line-height: 1.4;
        }
        
        .message-time {
            font-size: 12px;
            opacity: 0.7;
            margin-top: 5px;
        }
        
        .message-input {
            display: flex;
            gap: 15px;
            padding: 20px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 15px;
            backdrop-filter: blur(10px);
        }
        
        .message-input input {
            flex: 1;
            margin: 0;
            border-radius: 25px;
            padding: 15px 20px;
        }
        
        .message-input button {
            width: auto;
            margin: 0;
            padding: 15px 25px;
            border-radius: 25px;
            white-space: nowrap;
        }
        
        .stats {
            margin-bottom: 25px;
            padding: 20px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 15px;
            backdrop-filter: blur(10px);
        }
        
        .stats h3 {
            margin-bottom: 15px;
            color: #4ecdc4;
            font-size: 18px;
        }
        
        .stat-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            font-size: 14px;
            padding: 8px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .stat-value {
            font-weight: 600;
            color: #4ecdc4;
        }
        
        .typing-indicator {
            font-style: italic;
            color: #888;
            font-size: 14px;
            margin: 10px 20px;
            min-height: 20px;
            animation: typing 1.5s infinite;
        }
        
        @keyframes typing {
            0%, 60%, 100% { opacity: 1; }
            30% { opacity: 0.5; }
        }
        
        .performance-monitor {
            margin-bottom: 20px;
            padding: 15px;
            background: rgba(0, 0, 0, 0.4);
            border-radius: 10px;
            font-size: 12px;
        }
        
        .performance-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
        }
        
        @media (max-width: 768px) {
            .container {
                grid-template-columns: 1fr;
                padding: 10px;
            }
            
            .sidebar {
                order: -1;
                margin-bottom: 20px;
            }
            
            .message {
                margin-left: 0 !important;
                margin-right: 0 !important;
            }
        }

        /* Room Management Buttons */
        .room-management {
            margin: 20px 0;
            padding: 15px 0;
            border-top: 1px solid rgba(255,255,255,0.1);
        }

        .room-management h4 {
            margin-bottom: 15px;
            color: #4ecdc4;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .room-management button {
            width: 100%;
            margin-bottom: 8px;
            padding: 10px 15px;
            border: none;
            border-radius: 8px;
            color: white;
            font-weight: 600;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .room-management button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }

        .room-management button:active {
            transform: translateY(0);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="main-content">
        <div class="header">
            <h1>üöÄ LiveStream Chat - High Performance</h1>
            <p>‚ú® Message Buffer System v·ªõi Batch Processing cho 500+ users</p>
            <div style="margin-top: 15px;">
                <a href="/dashboard.html" target="_blank" style="
                    background: linear-gradient(45deg, #667eea, #764ba2);
                    color: white;
                    padding: 10px 20px;
                    border-radius: 25px;
                    text-decoration: none;
                    font-weight: bold;
                    display: inline-flex;
                    align-items: center;
                    gap: 8px;
                    transition: all 0.3s ease;
                    box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
                " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(102, 126, 234, 0.4)'" 
                   onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 15px rgba(102, 126, 234, 0.3)'">
                    ‚öôÔ∏è Admin Dashboard
                </a>
            </div>
        </div>            <div id="connectionStatus" class="connection-status disconnected">
                <div class="status-dot"></div>
                <span>‚ùå Ch∆∞a k·∫øt n·ªëi</span>
            </div>
            
            <div id="loginForm" class="auth-section">
                <h2>üîê ƒêƒÉng nh·∫≠p v√†o h·ªá th·ªëng</h2>
                
                <div class="form-group">
                    <label for="studentId">üìö M√£ sinh vi√™n:</label>
                    <input type="text" id="studentId" placeholder="Nh·∫≠p m√£ sinh vi√™n c·ªßa b·∫°n" required>
                </div>
                
                <div class="form-group">
                    <label for="birthDate">üéÇ Ng√†y sinh (DDMMYY):</label>
                    <input type="text" id="birthDate" placeholder="V√≠ d·ª•: 150807" maxlength="6" required>
                </div>
                
                <button onclick="loginUser()" id="loginButton">üöÄ ƒêƒÉng nh·∫≠p</button>
                
                <div id="loginError" style="color: #ff6b6b; margin-top: 15px; display: none; padding: 10px; background: rgba(255, 107, 107, 0.1); border-radius: 8px;"></div>
            </div>

            <div id="chatJoinForm" class="auth-section" style="display: none;">
                <h2>üí¨ Tham gia ph√≤ng chat</h2>
                
                <div id="userInfo" style="margin-bottom: 20px; padding: 20px; background: rgba(78, 205, 196, 0.1); border-radius: 10px; border: 1px solid rgba(78, 205, 196, 0.3);">
                    <div style="margin-bottom: 8px;">üë§ <strong id="userFullName"></strong></div>
                    <div style="margin-bottom: 8px;">üìö M√£ SV: <strong id="userStudentId"></strong></div>
                    <div>üïê L·∫ßn ƒëƒÉng nh·∫≠p: <strong id="userLoginCount"></strong></div>
                </div>
                
                <div class="form-group">
                    <label for="roomId">üè† M√£ ph√≤ng:</label>
                    <input type="text" id="roomId" value="test-room-001" placeholder="Nh·∫≠p m√£ ph√≤ng">
                </div>
                
                <button onclick="joinRoom()" id="joinRoomButton">üöÄ Tham gia ph√≤ng chat</button>
                
                <button onclick="logout()" style="background: linear-gradient(45deg, #ff6b6b, #ee5a52); margin-top: 15px;">üö™ ƒêƒÉng xu·∫•t</button>
            </div>
            
            <div id="chatContainer" class="chat-container">
                <div id="chatMessages" class="chat-messages"></div>
                <div id="typingIndicator" class="typing-indicator"></div>
                
                <div class="message-input">
                    <input type="text" id="messageInput" placeholder="Tham gia ph√≤ng ƒë·ªÉ chat..." maxlength="500" disabled>
                    <button onclick="sendMessage()" id="sendButton" disabled>üì§ G·ª≠i</button>
                </div>
            </div>
        </div>
        
        <div class="sidebar">
            <div class="performance-monitor">
                <h4>‚ö° Performance Monitor</h4>
                <div class="performance-item">
                    <span>Buffer Status:</span>
                    <span id="bufferStatus" class="stat-value">-</span>
                </div>
                <div class="performance-item">
                    <span>Pending Writes:</span>
                    <span id="pendingWrites" class="stat-value">0</span>
                </div>
                <div class="performance-item">
                    <span>Msg/sec:</span>
                    <span id="msgPerSec" class="stat-value">0</span>
                </div>
            </div>
            
            <div class="stats">
                <h3>üìä Th·ªëng k√™ ph√≤ng</h3>
                <div class="stat-item">
                    <span>üë• Ng∆∞·ªùi xem:</span>
                    <span id="viewerCount" class="stat-value">0</span>
                </div>
                <div class="stat-item">
                    <span>üí¨ Tin nh·∫Øn:</span>
                    <span id="messageCount" class="stat-value">0</span>
                </div>
                <div class="stat-item">
                    <span>‚ö° Ping:</span>
                    <span id="pingTime" class="stat-value">- ms</span>
                </div>
                <div class="stat-item">
                    <span>üïê Uptime:</span>
                    <span id="uptime" class="stat-value">00:00</span>
                </div>
            </div>
            
            <button onclick="leaveRoom()" style="background: linear-gradient(45deg, #ff6b6b, #ee5a52);">üö™ R·ªùi ph√≤ng</button>
            <button onclick="clearMessages()" style="background: linear-gradient(45deg, #ffa726, #ff9800); margin-top: 10px;">üóëÔ∏è X√≥a tin nh·∫Øn</button>
            <button onclick="getBufferStats()" style="background: linear-gradient(45deg, #9c27b0, #8e24aa); margin-top: 10px;">üìä Buffer Stats</button>
            
            <div class="room-management">
                <h4>üè† Qu·∫£n l√Ω ph√≤ng</h4>
                <button onclick="showCreateRoomForm()" style="background: linear-gradient(45deg, #4CAF50, #45a049);">‚ûï T·∫°o ph√≤ng m·ªõi</button>
                <button onclick="showRoomInfoDialog()" style="background: linear-gradient(45deg, #2196F3, #1976D2);">üìã Th√¥ng tin ph√≤ng</button>
                <button onclick="loadRoomHistory()" style="background: linear-gradient(45deg, #FF9800, #F57C00);">üìú L·ªãch s·ª≠ chat</button>
                <button onclick="endCurrentRoom()" style="background: linear-gradient(45deg, #f44336, #d32f2f);">üîö K·∫øt th√∫c ph√≤ng</button>
            </div>
            
            <div class="room-management">
                <h4>üåê Server</h4>
                <button onclick="showServerStatsDialog()" style="background: linear-gradient(45deg, #9C27B0, #7B1FA2);">üìä Th·ªëng k√™ server</button>
                <button onclick="checkServerHealth()" style="background: linear-gradient(45deg, #607D8B, #455A64);">üíì Ki·ªÉm tra s·ª©c kh·ªèe</button>
            </div>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        // ==================== CONFIG ====================
        // üîß DEVELOPMENT CONFIG (Local Testing)
        const API_BASE_URL = 'http://localhost:5500';
        const WS_URL = 'ws://localhost:5500';

        // üöÄ PRODUCTION CONFIG (Uncomment when deploying)
        // const API_BASE_URL = 'https://stream.bancongnghe.tech';
        // const WS_URL = 'wss://stream.bancongnghe.tech';
        
        let socket = null;
        let currentRoom = null;
        let currentUser = null;
        let authenticatedUser = null;
        let messageCount = 0;
        let typingTimer = null;
        let pingInterval = null;
        let startTime = null;
        let messageRateCounter = 0;
        let lastMessageTime = Date.now();

        // Performance monitoring
        let performanceStats = {
            totalMessages: 0,
            avgResponseTime: 0,
            bufferSize: 0
        };

        // üç™ Utility function to get cookie value
        function getCookieValue(name) {
            const value = `; ${document.cookie}`;
            const parts = value.split(`; ${name}=`);
            if (parts.length === 2) return parts.pop().split(';').shift();
            return null;
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            checkAuthenticationStatus();
            setupEventListeners();
            startPerformanceMonitoring();
            
            // Connect socket immediately for better UX
            initializeSocket();
        });

        function setupEventListeners() {
            // Message input Enter key
            const messageInput = document.getElementById('messageInput');
            if (messageInput) {
                messageInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        sendMessage();
                    }
                });
                
                // Typing indicator
                messageInput.addEventListener('input', function() {
                    if (socket && currentRoom) {
                        socket.emit('typing', { roomId: currentRoom, isTyping: true });
                        
                        clearTimeout(typingTimer);
                        typingTimer = setTimeout(() => {
                            socket.emit('typing', { roomId: currentRoom, isTyping: false });
                        }, 2000);
                    }
                });
            }
            
            // Login form Enter key
            ['studentId', 'birthDate'].forEach(id => {
                const input = document.getElementById(id);
                if (input) {
                    input.addEventListener('keypress', function(e) {
                        if (e.key === 'Enter') {
                            e.preventDefault();
                            loginUser();
                        }
                    });
                }
            });
            
            // Room ID Enter key
            const roomInput = document.getElementById('roomId');
            if (roomInput) {
                roomInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        joinRoom();
                    }
                });
            }
        }

        function startPerformanceMonitoring() {
            setInterval(() => {
                updateUptime();
                updateMessageRate();
            }, 1000);
        }

        function updateUptime() {
            if (startTime) {
                const now = Date.now();
                const diff = Math.floor((now - startTime) / 1000);
                const minutes = Math.floor(diff / 60);
                const seconds = diff % 60;
                document.getElementById('uptime').textContent = 
                    `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            }
        }

        function updateMessageRate() {
            const now = Date.now();
            if (now - lastMessageTime > 1000) {
                document.getElementById('msgPerSec').textContent = messageRateCounter;
                messageRateCounter = 0;
                lastMessageTime = now;
            }
        }

        function initializeSocket() {
            if (socket) {
                socket.disconnect();
            }
            
            // üîê Try multiple authentication methods
            const token = getCookieValue('access_token');
            console.log('üç™ Cookie token found:', token ? 'Yes ‚úÖ' : 'No ‚ùå');
            
            const socketOptions = {
                transports: ['websocket', 'polling'],
                upgrade: true,
                rememberUpgrade: true,
                withCredentials: true  // üîê Method 1: Send cookies
            };
            
            // üîê Method 2: Fallback with query parameter if token exists
            if (token) {
                socketOptions.query = { token };
                console.log('üîë Using token in query parameter as fallback');
            }
            
            console.log('üöÄ Connecting with options:', socketOptions);
            
            socket = io(WS_URL, socketOptions);

            socket.on('connect', () => {
                updateConnectionStatus(true, 'K·∫øt n·ªëi th√†nh c√¥ng');
                startPingMonitoring();
                console.log('‚úÖ Connected to server');
            });

            socket.on('connect_error', (error) => {
                console.error('‚ùå Connection error:', error);
                if (error.message && error.message.includes('Authentication')) {
                    updateConnectionStatus(false, 'üîê L·ªói x√°c th·ª±c - Vui l√≤ng ƒëƒÉng nh·∫≠p l·∫°i');
                    // Redirect to login if auth failed
                    setTimeout(() => {
                        showLoginForm();
                    }, 2000);
                } else {
                    updateConnectionStatus(false, `üîå L·ªói k·∫øt n·ªëi: ${error.message || 'Unknown error'}`);
                }
            });

            socket.on('disconnect', (reason) => {
                updateConnectionStatus(false, `M·∫•t k·∫øt n·ªëi: ${reason}`);
                stopPingMonitoring();
                console.log('‚ùå Disconnected:', reason);
            });

            socket.on('error', (error) => {
                console.error('Socket error:', error);
                updateConnectionStatus(false, `L·ªói: ${error.message}`);
            });

            // Chat events
            socket.on('newMessage', (message) => {
                displayMessage(message);
                messageRateCounter++;
                performanceStats.totalMessages++;
            });

            socket.on('userJoined', (data) => {
                console.log('User joined:', data);
                updateStats(data);
                
                // Enable message input when successfully joined
                if (data.userId === currentUser?.userId) {
                    const messageInput = document.getElementById('messageInput');
                    const sendButton = document.getElementById('sendButton');
                    
                    messageInput.disabled = false;
                    messageInput.placeholder = 'Nh·∫≠p tin nh·∫Øn...';
                    sendButton.disabled = false;
                    
                    console.log('‚úÖ Message input enabled');
                }
            });

            socket.on('userLeft', (data) => {
                console.log('User left:', data);
                updateStats(data);
            });

            socket.on('typing', (data) => {
                updateTypingIndicator(data);
            });

            socket.on('roomStats', (stats) => {
                updateStats(stats);
            });

            socket.on('pong', (timestamp) => {
                const ping = Date.now() - timestamp;
                document.getElementById('pingTime').textContent = ping + ' ms';
                
                // Update performance stats
                performanceStats.avgResponseTime = ping;
            });
        }

        async function checkAuthenticationStatus() {
            try {
                const response = await fetch(`${API_BASE_URL}/auth/verify`, {
                    method: 'GET',
                    credentials: 'include',
                });

                const result = await response.json();
                
                if (result.valid && result.user) {
                    authenticatedUser = result.user;
                    showChatJoinForm();
                    updateConnectionStatus(socket?.connected || false, 'ƒê√£ ƒëƒÉng nh·∫≠p - S·∫µn s√†ng tham gia ph√≤ng chat');
                }
            } catch (error) {
                console.log('Not authenticated:', error);
            }
        }

        async function loginUser() {
            const studentId = document.getElementById('studentId').value.trim();
            const birthDate = document.getElementById('birthDate').value.trim();
            const loginButton = document.getElementById('loginButton');
            const loginError = document.getElementById('loginError');

            if (!studentId || !birthDate) {
                showLoginError('‚ö†Ô∏è Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß m√£ sinh vi√™n v√† ng√†y sinh');
                return;
            }

            if (birthDate.length !== 6) {
                showLoginError('‚ö†Ô∏è Ng√†y sinh ph·∫£i c√≥ ƒë·ªãnh d·∫°ng DDMMYY (6 s·ªë)');
                return;
            }

            loginButton.disabled = true;
            loginButton.textContent = '‚è≥ ƒêang ƒëƒÉng nh·∫≠p...';
            loginError.style.display = 'none';

            try {
                const response = await fetch(`${API_BASE_URL}/auth/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    credentials: 'include',
                    body: JSON.stringify({ studentId, birthDate }),
                });

                const result = await response.json();

                if (response.ok) {
                    authenticatedUser = result.user;
                    showChatJoinForm();
                    updateConnectionStatus(socket?.connected || false, '‚úÖ ƒêƒÉng nh·∫≠p th√†nh c√¥ng');
                } else {
                    showLoginError('‚ùå ' + (result.message || 'ƒêƒÉng nh·∫≠p th·∫•t b·∫°i'));
                }
            } catch (error) {
                console.error('Login error:', error);
                showLoginError('üîå L·ªói k·∫øt n·ªëi server. Vui l√≤ng th·ª≠ l·∫°i.');
            } finally {
                loginButton.disabled = false;
                loginButton.textContent = 'üöÄ ƒêƒÉng nh·∫≠p';
            }
        }

        function showLoginError(message) {
            const loginError = document.getElementById('loginError');
            loginError.textContent = message;
            loginError.style.display = 'block';
            
            // Auto hide after 5 seconds
            setTimeout(() => {
                loginError.style.display = 'none';
            }, 5000);
        }

        function showChatJoinForm() {
            document.getElementById('loginForm').style.display = 'none';
            document.getElementById('chatJoinForm').style.display = 'block';
            
            // Display user info with animation
            document.getElementById('userFullName').textContent = authenticatedUser.fullName;
            document.getElementById('userStudentId').textContent = authenticatedUser.studentId;
            document.getElementById('userLoginCount').textContent = authenticatedUser.loginCount;
            
            // Focus on room input
            setTimeout(() => {
                document.getElementById('roomId').focus();
            }, 100);
        }

        async function logout() {
            try {
                await fetch(`${API_BASE_URL}/auth/logout`, {
                    method: 'POST',
                    credentials: 'include',
                });
            } catch (error) {
                console.error('Logout error:', error);
            }
            
            // Reset all state
            authenticatedUser = null;
            currentUser = null;
            currentRoom = null;
            messageCount = 0;
            startTime = null;
            
            // Disconnect socket
            if (socket) {
                socket.disconnect();
            }
            
            // Reset UI
            document.getElementById('loginForm').style.display = 'block';
            document.getElementById('chatJoinForm').style.display = 'none';
            document.getElementById('chatContainer').style.display = 'none';
            
            // Disable message input
            const messageInput = document.getElementById('messageInput');
            const sendButton = document.getElementById('sendButton');
            
            if (messageInput && sendButton) {
                messageInput.disabled = true;
                messageInput.placeholder = 'Tham gia ph√≤ng ƒë·ªÉ chat...';
                sendButton.disabled = true;
            }
            
            // Clear forms
            document.getElementById('studentId').value = '';
            document.getElementById('birthDate').value = '';
            document.getElementById('chatMessages').innerHTML = '';
            
            updateConnectionStatus(false, 'üö™ ƒê√£ ƒëƒÉng xu·∫•t');
        }

        function joinRoom() {
            if (!authenticatedUser) {
                alert('‚ö†Ô∏è Vui l√≤ng ƒëƒÉng nh·∫≠p tr∆∞·ªõc!');
                return;
            }

            const roomId = document.getElementById('roomId').value.trim();
            if (!roomId) {
                alert('‚ö†Ô∏è Vui l√≤ng nh·∫≠p m√£ ph√≤ng!');
                return;
            }

            const joinButton = document.getElementById('joinRoomButton');
            joinButton.disabled = true;
            joinButton.textContent = '‚è≥ ƒêang tham gia...';

            currentRoom = roomId;
            currentUser = {
                userId: 'user_' + Math.random().toString(36).substr(2, 9),
                username: authenticatedUser.fullName,
                studentId: authenticatedUser.studentId
            };

            // Make sure socket is connected
            if (!socket || !socket.connected) {
                initializeSocket();
                setTimeout(() => {
                    socket.emit('joinRoom', { roomId, userId: currentUser.userId, username: currentUser.username });
                }, 1000);
            } else {
                socket.emit('joinRoom', { roomId, userId: currentUser.userId, username: currentUser.username });
            }

            // Hide join form, show chat
            document.getElementById('chatJoinForm').style.display = 'none';
            document.getElementById('chatContainer').style.display = 'flex';
            
            // Enable message input (backup - will also be enabled by socket event)
            setTimeout(() => {
                const messageInput = document.getElementById('messageInput');
                const sendButton = document.getElementById('sendButton');
                
                if (messageInput && sendButton) {
                    messageInput.disabled = false;
                    messageInput.placeholder = 'Nh·∫≠p tin nh·∫Øn...';
                    sendButton.disabled = false;
                    messageInput.focus();
                }
            }, 1500);
            
            // Start timer
            startTime = Date.now();
            
            joinButton.disabled = false;
            joinButton.textContent = 'üöÄ Tham gia ph√≤ng chat';
        }

        function leaveRoom() {
            if (socket && currentRoom && currentUser) {
                socket.emit('leaveRoom', {
                    roomId: currentRoom,
                    userId: currentUser.userId
                });
            }

            // Disable message input
            const messageInput = document.getElementById('messageInput');
            const sendButton = document.getElementById('sendButton');
            
            messageInput.disabled = true;
            messageInput.placeholder = 'Tham gia ph√≤ng ƒë·ªÉ chat...';
            sendButton.disabled = true;

            // Reset state
            currentRoom = null;
            currentUser = null;
            messageCount = 0;
            startTime = null;

            // Reset UI
            document.getElementById('chatJoinForm').style.display = 'block';
            document.getElementById('chatContainer').style.display = 'none';
            document.getElementById('chatMessages').innerHTML = '';
            document.getElementById('typingIndicator').textContent = '';
            
            // Reset stats
            document.getElementById('viewerCount').textContent = '0';
            document.getElementById('messageCount').textContent = '0';
            document.getElementById('uptime').textContent = '00:00';
        }

        function sendMessage() {
            const messageInput = document.getElementById('messageInput');
            const message = messageInput.value.trim();

            if (!message) {
                return; // Silent return for empty messages
            }
            
            if (!socket || !socket.connected) {
                alert('üîå Ch∆∞a k·∫øt n·ªëi! Vui l√≤ng th·ª≠ l·∫°i.');
                return;
            }
            
            if (!currentRoom || !currentUser) {
                alert('‚ö†Ô∏è B·∫°n ch∆∞a tham gia ph√≤ng n√†o!');
                return;
            }

            // Send message
            socket.emit('sendMessage', {
                message: message,
                type: 'text'
            });

            messageInput.value = '';
            messageRateCounter++;
        }

        function displayMessage(message) {
            const messagesContainer = document.getElementById('chatMessages');
            const messageEl = document.createElement('div');
            
            const isOwnMessage = message.userId === currentUser?.userId;
            messageEl.className = `message ${isOwnMessage ? 'own' : 'other'}`;
            
            const time = new Date(message.timestamp).toLocaleTimeString('vi-VN', {
                hour: '2-digit',
                minute: '2-digit'
            });
            
            messageEl.innerHTML = `
                <div class="message-header">
                    ${isOwnMessage ? 'B·∫°n' : message.username} 
                </div>
                <div class="message-content">${escapeHtml(message.message)}</div>
                <div class="message-time">${time}</div>
            `;
            
            messagesContainer.appendChild(messageEl);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
            
            // Update message count
            messageCount++;
            document.getElementById('messageCount').textContent = messageCount;
        }

        function updateStats(data) {
            if (data.viewerCount !== undefined) {
                document.getElementById('viewerCount').textContent = data.viewerCount;
            }
            if (data.messageCount !== undefined) {
                document.getElementById('messageCount').textContent = data.messageCount;
            }
        }

        function updateTypingIndicator(data) {
            const indicator = document.getElementById('typingIndicator');
            
            if (data.isTyping && data.userId !== currentUser?.userId) {
                indicator.textContent = `üí≠ ${data.username} ƒëang nh·∫≠p...`;
            } else {
                indicator.textContent = '';
            }
        }

        function updateConnectionStatus(connected, message) {
            const statusEl = document.getElementById('connectionStatus');
            const dotEl = statusEl.querySelector('.status-dot');
            const textEl = statusEl.querySelector('span');
            
            statusEl.className = `connection-status ${connected ? 'connected' : 'disconnected'}`;
            textEl.textContent = message;
        }

        function startPingMonitoring() {
            if (pingInterval) return;
            
            pingInterval = setInterval(() => {
                if (socket && socket.connected) {
                    const start = Date.now();
                    socket.emit('ping', start);
                }
            }, 5000);
        }

        function stopPingMonitoring() {
            if (pingInterval) {
                clearInterval(pingInterval);
                pingInterval = null;
            }
        }

        // Utility functions
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function clearMessages() {
            if (confirm('üóëÔ∏è X√≥a t·∫•t c·∫£ tin nh·∫Øn trong ph√≤ng?')) {
                document.getElementById('chatMessages').innerHTML = '';
                messageCount = 0;
                document.getElementById('messageCount').textContent = '0';
            }
        }

        async function getBufferStats() {
            try {
                const response = await fetch(`${API_BASE_URL}/admin/buffer-stats`);
                const stats = await response.json();
                
                document.getElementById('bufferStatus').textContent = 
                    stats.pendingWrites > 0 ? 'Buffering' : 'Synced';
                document.getElementById('pendingWrites').textContent = stats.pendingWrites;
                
                console.log('üìä Buffer Stats:', stats);
                alert(`üìä Buffer Stats:
‚Ä¢ Pending Writes: ${stats.pendingWrites}
‚Ä¢ Total Recent Messages: ${stats.totalRecentMessages}
‚Ä¢ Active Rooms: ${stats.activeRooms}
‚Ä¢ Flush Interval: ${stats.flushInterval}ms
‚Ä¢ Batch Size: ${stats.batchSize}`);
            } catch (error) {
                console.error('Error getting buffer stats:', error);
                alert('‚ùå Kh√¥ng th·ªÉ l·∫•y th·ªëng k√™ buffer');
            }
        }

        // ==================== ROOM MANAGEMENT APIs ====================

        /**
         * Create a new live room
         */
        async function createRoom(roomData) {
            try {
                const response = await fetch(`${API_BASE_URL}/api/rooms`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    credentials: 'include',
                    body: JSON.stringify(roomData),
                });

                const result = await response.json();
                
                if (result.success) {
                    console.log('‚úÖ Room created successfully:', result.data);
                    return result.data;
                } else {
                    console.error('‚ùå Failed to create room:', result.error);
                    throw new Error(result.error);
                }
            } catch (error) {
                console.error('üîå Network error creating room:', error);
                throw error;
            }
        }

        /**
         * Get room information
         */
        async function getRoomInfo(roomId) {
            try {
                const response = await fetch(`${API_BASE_URL}/api/rooms/${roomId}`, {
                    method: 'GET',
                    credentials: 'include',
                });

                const result = await response.json();
                
                if (result.success) {
                    console.log('üìã Room info retrieved:', result.data);
                    return result.data;
                } else {
                    console.error('‚ùå Failed to get room info:', result.error);
                    return null;
                }
            } catch (error) {
                console.error('üîå Network error getting room info:', error);
                return null;
            }
        }

        /**
         * Get room messages
         */
        async function getRoomMessages(roomId, limit = 100) {
            try {
                const response = await fetch(`${API_BASE_URL}/api/rooms/${roomId}/messages?limit=${limit}`, {
                    method: 'GET',
                    credentials: 'include',
                });

                const result = await response.json();
                
                if (result.success) {
                    console.log('üí¨ Room messages retrieved:', result.data.length, 'messages');
                    return result.data;
                } else {
                    console.error('‚ùå Failed to get room messages:', result.error);
                    return [];
                }
            } catch (error) {
                console.error('üîå Network error getting room messages:', error);
                return [];
            }
        }

        /**
         * End a live room
         */
        async function endRoom(roomId) {
            try {
                const response = await fetch(`${API_BASE_URL}/api/rooms/${roomId}/end`, {
                    method: 'POST',
                    credentials: 'include',
                });

                const result = await response.json();
                
                if (result.success) {
                    console.log('üîö Room ended successfully');
                    return true;
                } else {
                    console.error('‚ùå Failed to end room:', result.error);
                    return false;
                }
            } catch (error) {
                console.error('üîå Network error ending room:', error);
                return false;
            }
        }

        /**
         * Get server statistics
         */
        async function getServerStats() {
            try {
                const response = await fetch(`${API_BASE_URL}/api/stats`, {
                    method: 'GET',
                    credentials: 'include',
                });

                const result = await response.json();
                
                if (result.success) {
                    console.log('üìä Server stats retrieved:', result.data);
                    return result.data;
                } else {
                    console.error('‚ùå Failed to get server stats:', result.error);
                    return null;
                }
            } catch (error) {
                console.error('üîå Network error getting server stats:', error);
                return null;
            }
        }

        /**
         * Get health status
         */
        async function getHealthStatus() {
            try {
                const response = await fetch(`${API_BASE_URL}/api/health`, {
                    method: 'GET',
                });

                const result = await response.json();
                console.log('üíì Health status:', result);
                return result;
            } catch (error) {
                console.error('üîå Network error getting health status:', error);
                return null;
            }
        }

        // ==================== ROOM MANAGEMENT UI FUNCTIONS ====================

        /**
         * Show room creation form
         */
        function showCreateRoomForm() {
            const roomId = prompt('üè† Nh·∫≠p Room ID (ch·ªâ ch·ªØ, s·ªë, _, -):');
            if (!roomId) return;

            if (!/^[a-zA-Z0-9_-]+$/.test(roomId)) {
                alert('‚ùå Room ID ch·ªâ ƒë∆∞·ª£c ch·ª©a ch·ªØ c√°i, s·ªë, g·∫°ch d∆∞·ªõi v√† g·∫°ch ngang');
                return;
            }

            const title = prompt('üìù Nh·∫≠p ti√™u ƒë·ªÅ ph√≤ng:');
            if (!title) return;

            const description = prompt('üìÑ Nh·∫≠p m√¥ t·∫£ ph√≤ng (t√πy ch·ªçn):') || '';

            createRoomWithForm(roomId, title, description);
        }

        /**
         * Create room with form data
         */
        async function createRoomWithForm(roomId, title, description = '') {
            if (!authenticatedUser) {
                alert('‚ùå Vui l√≤ng ƒëƒÉng nh·∫≠p tr∆∞·ªõc khi t·∫°o ph√≤ng');
                return;
            }

            const roomData = {
                roomId: roomId,
                title: title,
                hostId: authenticatedUser.studentId,
                hostName: authenticatedUser.fullName,
                description: description,
                settings: {
                    maxChatLength: 500,
                    slowMode: 0,
                    moderatorMode: false,
                    allowGuests: true,
                    category: 'general'
                }
            };

            try {
                const room = await createRoom(roomData);
                alert(`‚úÖ T·∫°o ph√≤ng th√†nh c√¥ng!\nüè† Room ID: ${room.roomId}\nüìù Ti√™u ƒë·ªÅ: ${room.title}`);
                
                // Auto join the created room
                document.getElementById('roomId').value = roomId;
                joinRoom();
            } catch (error) {
                alert(`‚ùå Kh√¥ng th·ªÉ t·∫°o ph√≤ng: ${error.message}`);
            }
        }

        /**
         * Show room info
         */
        async function showRoomInfoDialog() {
            const roomId = document.getElementById('roomId').value.trim();
            if (!roomId) {
                alert('‚ùå Vui l√≤ng nh·∫≠p Room ID');
                return;
            }

            const roomInfo = await getRoomInfo(roomId);
            if (!roomInfo) {
                alert('‚ùå Kh√¥ng t√¨m th·∫•y ph√≤ng ho·∫∑c ph√≤ng kh√¥ng ho·∫°t ƒë·ªông');
                return;
            }

            const info = `üìã TH√îNG TIN PH√íNG

üè† Room ID: ${roomInfo.roomId}
üìù Ti√™u ƒë·ªÅ: ${roomInfo.title}
üëë Host: ${roomInfo.hostName} (${roomInfo.hostId})
üë• Ng∆∞·ªùi xem: ${roomInfo.viewerCount}
üìä Tr·∫°ng th√°i: ${roomInfo.isActive ? 'ƒêang ho·∫°t ƒë·ªông' : 'ƒê√£ k·∫øt th√∫c'}
‚è∞ B·∫Øt ƒë·∫ßu: ${new Date(roomInfo.startTime).toLocaleString('vi-VN')}
üí¨ Tin nh·∫Øn hi·ªán t·∫°i: ${roomInfo.messageCount}
üë§ Ng∆∞·ªùi d√πng hi·ªán t·∫°i: ${roomInfo.currentUsers}

‚öôÔ∏è C√ÄI ƒê·∫∂T:
‚Ä¢ ƒê·ªô d√†i tin nh·∫Øn t·ªëi ƒëa: ${roomInfo.settings?.maxChatLength || 500}
‚Ä¢ Ch·∫ø ƒë·ªô ch·∫≠m: ${roomInfo.settings?.slowMode || 0}s
‚Ä¢ Ch·∫ø ƒë·ªô ki·ªÉm duy·ªát: ${roomInfo.settings?.moderatorMode ? 'B·∫≠t' : 'T·∫Øt'}
‚Ä¢ Cho ph√©p kh√°ch: ${roomInfo.settings?.allowGuests ? 'C√≥' : 'Kh√¥ng'}`;

            alert(info);
        }

        /**
         * Show server statistics
         */
        async function showServerStatsDialog() {
            const stats = await getServerStats();
            if (!stats) {
                alert('‚ùå Kh√¥ng th·ªÉ l·∫•y th·ªëng k√™ server');
                return;
            }

            const info = `üìä TH·ªêNG K√ä SERVER

üè† T·ªïng s·ªë ph√≤ng: ${stats.totalRooms}
üë• T·ªïng ng∆∞·ªùi d√πng: ${stats.totalUsers}
‚è∞ C·∫≠p nh·∫≠t l√∫c: ${new Date(stats.timestamp).toLocaleString('vi-VN')}

üìã DANH S√ÅCH PH√íNG:
${stats.rooms.map(room => 
    `‚Ä¢ ${room.roomId} (${room.userCount} ng∆∞·ªùi)`
).join('\n')}`;

            alert(info);
        }

        /**
         * End current room (only for room host)
         */
        async function endCurrentRoom() {
            const roomId = document.getElementById('roomId').value.trim();
            if (!roomId) {
                alert('‚ùå Kh√¥ng c√≥ ph√≤ng n√†o ƒëang ho·∫°t ƒë·ªông');
                return;
            }

            if (!authenticatedUser) {
                alert('‚ùå Vui l√≤ng ƒëƒÉng nh·∫≠p');
                return;
            }

            // Get room info to check if user is host
            const roomInfo = await getRoomInfo(roomId);
            if (!roomInfo) {
                alert('‚ùå Kh√¥ng t√¨m th·∫•y ph√≤ng');
                return;
            }

            if (roomInfo.hostId !== authenticatedUser.studentId) {
                alert('‚ùå Ch·ªâ host m·ªõi c√≥ th·ªÉ k·∫øt th√∫c ph√≤ng');
                return;
            }

            if (!confirm(`üîö B·∫°n c√≥ ch·∫Øc mu·ªën k·∫øt th√∫c ph√≤ng "${roomInfo.title}"?`)) {
                return;
            }

            const success = await endRoom(roomId);
            if (success) {
                alert('‚úÖ K·∫øt th√∫c ph√≤ng th√†nh c√¥ng');
                leaveRoom();
            } else {
                alert('‚ùå Kh√¥ng th·ªÉ k·∫øt th√∫c ph√≤ng');
            }
        }

        /**
         * Load room messages history
         */
        async function loadRoomHistory() {
            const roomId = document.getElementById('roomId').value.trim();
            if (!roomId) {
                alert('‚ùå Vui l√≤ng nh·∫≠p Room ID');
                return;
            }

            const messages = await getRoomMessages(roomId, 50);
            if (messages.length === 0) {
                alert('üì≠ Ph√≤ng ch∆∞a c√≥ tin nh·∫Øn n√†o');
                return;
            }

            // Clear current messages and load history
            document.getElementById('chatMessages').innerHTML = '';
            messageCount = 0;

            messages.forEach(message => {
                addMessage(message);
            });

            alert(`üìú ƒê√£ t·∫£i ${messages.length} tin nh·∫Øn g·∫ßn nh·∫•t`);
        }

        /**
         * Check server health
         */
        async function checkServerHealth() {
            const health = await getHealthStatus();
            if (!health) {
                alert('‚ùå Kh√¥ng th·ªÉ ki·ªÉm tra tr·∫°ng th√°i server');
                return;
            }

            const uptimeHours = Math.floor(health.uptime / 3600);
            const uptimeMinutes = Math.floor((health.uptime % 3600) / 60);
            const memoryUsed = Math.round(health.memory.heapUsed / 1024 / 1024);
            const memoryTotal = Math.round(health.memory.heapTotal / 1024 / 1024);

            const info = `üíì TR·∫†NG TH√ÅI SERVER

‚úÖ Status: ${health.status}
‚è∞ Uptime: ${uptimeHours}h ${uptimeMinutes}m
üñ•Ô∏è Memory: ${memoryUsed}MB / ${memoryTotal}MB
üìÖ Th·ªùi gian: ${health.timestamp}
üóÉÔ∏è Session: ${health.session?.status || 'Unknown'}`;

            alert(info);
        }
    </script>
</body>
</html>
